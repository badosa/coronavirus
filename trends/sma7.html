<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8">
    <title>Worldwide Real-time COVID-19 Trends</title>
    <link href="https://visual.js.org/visual.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet">
    <script src="https://visual.js.org/lazyvisualsetup.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }
      body, #visual, #VisualJSTooltip, .legendLabel, select {
        font-family: 'Lato', sans-serif;
        font-size: 14px;
      }
      select {
        position: absolute;
        top: 2px;
        right: 20px;
        background-color: hsla(240, 100%, 25%, 1);
        color: #fff;
      }
      .VisualJSfooter p {
        font-size: 14px;
        font-weight: bold;
        }
    </style>
  </head>
  <body>
    <select></select>
    <div id="visual" class="visual">Retrieving data...</div>

    <script>
      if(typeof fetch!=="function" || typeof URLSearchParams!=="function"){
        window.alert("Your browser is not modern enough to display this webpage. Sorry.");
      }

      var
        pars=new URLSearchParams(window.location.search),
        defCountry=pars.has("geo") ? pars.get("geo").toUpperCase() : "USA"
      ;

      VisualJS.setup.canvas.position="nw";
      VisualJS.setup.tooltipseparator=" on ";

      fetch("https://corona.lmao.ninja/v2/historical?lastdays=60").then(function(resp){
        resp.json().then(function(data) {
          var
            filtered=data.filter(function(c){
              return !c.province;
            }),
            countries=filtered.map(function(c){
              return c.country.toUpperCase();
            }),

            sma7=function(c,i,a){
              return (i>2 && i+3<a.length)
                ?
                ((a[i+3]-a[i-4])/7).toFixed(0)
                :
                null
              ;
            }

            viz=function(selCountry){
              var
                country=filtered.filter(function(c){
                  return c.country.toUpperCase()===selCountry;
                })[0].timeline,
                time=[]
                cases=[],
                deaths=[],
                recovered=[],
                t=null
              ;

              for(var k in country.cases){
                t=k.split("/");
                time.push("20"+t[2]+"/"+t[0]+"/"+t[1]);
                cases.push(Number(country.cases[k]));
                deaths.push(Number(country.deaths[k]));
                recovered.push(Number(country.recovered[k]));
              }

              cases=cases.map(sma7);
              deaths=deaths.map(sma7);
              recovered=recovered.map(sma7);
              time=time.map(function(c,i,a){
                return i>2 ? a[i-3] : null;
              });

              visual({
                footer: "Simple Moving Average (7 Periods) of Daily Differences",
                lang: "en",
                autoheading: true,
                time: time,
                grid: {
                  line: 5,
                  shadow: 6,
                  point: 0
                },
                axis: {
                  x: false
                },
                legend: true,
                type: "tsline",
                data: [
                  { label: "Cases", val: cases },
                  { label: "Deaths", val: deaths },
                  { label: "Recovered", val: recovered }
                ]
              });
            },
            select=function(country){
              var html="";
              country.forEach(function(c){
                var selected=(c===defCountry) ? 'selected': "";
                html+='<option value="'+c+'" ' + selected + '>'+c+'</option>';
              });

              document.querySelector("select").innerHTML=html;

              document.querySelector("select").addEventListener("change", function() {
              	viz(this.value);
              }, false);
            }
          ;

          countries.sort();
          select(countries);
          viz(defCountry);
        });
      });
    </script>

  </body>
</html>
