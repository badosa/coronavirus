<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8">
    <title>Worldwide Real-time COVID-19 Stats</title>
    <link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>

    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: 'Lato', sans-serif;
        font-size: 14px;
      }
      p {
        margin: 2px 0;
        text-align: left;
      }
      main {
        text-align: center;
      }
      #faketable {
        display: inline-block;
        width: 1135px; /*1262px;*/
      }
      #table {
        height: 490px;
        overflow-y: scroll;
      }

      caption, thead {
        position: absolute;
        left: -9999px;
      }

      #caption {
        font-size: 16px;
        text-align: left;
        font-weight: bold;
        margin: 0 0 4px 0;
      }
      .thead:first-of-type {
        margin-bottom: 2px;
      }
      .thead > span, td {
        text-align: right;
        padding: 4px 10px;
        width: 124px;
      }
      .thead > span {
        display: inline-block;
        background-color: #333;
        color: #fff;
        cursor: pointer;
        padding: 10px 5px 10px 10px;
        margin: 0 1px;
      }

      .thead > span:first-of-type,
      tr td:first-of-type {
        text-align: left;
      }

      tr:nth-child(even) * {
        background-color: #ddd;
      }

      .thead > span.sel {
        background-color: hsla(240, 100%, 25%, 1);
      }
      td.sel {
        background-color: hsla(240, 100%, 95%, 1);
      }

      tr:nth-child(even) .sel {
        background-color: hsla(240, 100%, 90%, 1);
      }

      tr.thou * {
        color: brown;
      }


      .thead > span.sel .arrow {
        opacity: 1;
      }

      .arrow {
        display: inline-block;
        vertical-align: middle;
        width: 0;
        height: 0;
        margin-left: 5px;
        opacity: 0.66;
      }

      .arrow.asc {
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-bottom: 4px solid #fff;
      }

      .arrow.dsc {
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
        border-top: 4px solid #fff;
      }
    </style>

    <script type="text/x-template" id="grid">
      <div id="faketable">
        <h1 id="caption" aria-hidden="true">{{title}}</h1>
        <p><label><input type="checkbox" v-model="filtered" /> Show only countries with more than 3,000 cases (showing: {{count}} countries)</label></p>

        <div class="thead" aria-hidden="true">
          <span v-for="key in columns"
            @click="sortBy(key)"
            :class="{ sel: sortKey == key || def == key }">
            {{ key | labelize }}
            <span class="arrow" :class="sortOrders[key] > 0 ? 'asc' : 'dsc'">
            </span>
          </span>
        </div>

        <div id="table">
          <table>
            <caption>{{title}}</caption>
            <thead>
              <tr>
                <th v-for="key in columns"
                  @click="sortBy(key)"
                  :class="{ sel: sortKey == key || def == key }">
                  {{ key | labelize }}
                  <span class="arrow" :class="sortOrders[key] > 0 ? 'asc' : 'dsc'">
                  </span>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="entry in sortedCountries" :class="{ thou: entry.cases>3000 }">
                <td v-for="key in columns" :class="{ sel: sortKey == key || def == key }">
                  {{ entry[key], key | formatNumber }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p>{{footer}}</p>
      </div>
    </script>
  </head>
  <body>
    <main>
      <grid
        title="Worldwide Real-time COVID-19 Stats"
        footer="Warning: Different countries report cases at different hours. Today data vary a lot over the course of the day."
        :countries="gridData"
        :columns="gridColumns"
      >
      </grid>
    </main>

    <script>
      if(typeof fetch!=="function"){
        window.alert("Your browser is not modern enough to display this webpage. Sorry.");
      }

      defaultCol="deaths";

      function labelize(str){
        var o={
          "country": "Country",
          "cases": "Cases",
          "todayCases": "Today Cases",
          "critical": "Critical",
          "recovered": "Recovered",
          "deaths": "Deaths",
          "todayDeaths": "Today Deaths",
          "rate": "Fatality Rate",
          "casesPerOneMillion": "Cases per 1M",
          "deathsPerOneMillion": "Deaths per 1M",
        };
        return o[str];
      }

      Vue.component("grid", {
        template: "#grid",
        props: {
          countries: Array,
          columns: Array,
          title: String,
          footer: String
        },
        data: function() {
          var sortOrders={};

          this.columns.forEach(function(key) {
            sortOrders[key] = defaultCol===key ? -1 : 1;
          });

          return {
            count: 0,
            filtered: true,
            def: defaultCol,
            sortKey: "",
            sortOrders: sortOrders
          };
        },
        computed: {
          sortedCountries: function(){
            var
              sortKey=this.sortKey,
              order=this.sortOrders[sortKey] || 1,
              countries=this.countries
            ;

            if(this.filtered){
              countries=countries.filter(function(c) {
                return c.cases>3000;
              });
            }

            if(sortKey){
              countries=countries.slice().sort(function(a, b){
                a=a[sortKey];
                b=b[sortKey];
                return (a===b ? 0 : a>b ? 1 : -1) * order;
              });

            }

            this.count=countries.length;
            return countries;
          }
        },
        filters: {
          labelize: labelize,
          formatNumber: function(n, key){
            if(typeof n==="number"){
              return (key!=="rate") ? new Intl.NumberFormat("en-US").format(n) : n.toFixed(2)+" %"
            }

            return n;
          }
        },
        methods: {
          sortBy: function(key){
            this.def="";
            this.sortKey=key;
            this.sortOrders[key]=this.sortOrders[key] * -1;
          }
        }
      });

      fetch("https://corona.lmao.ninja/v2/countries").then(function(resp){
        resp.json().then(function(data) {
          if(!data.length){
            document.body.innerText="Sorry, I could not retrieve any data. Please, try later.";
          }

          data.sort(function(a,b){
            return b[defaultCol] - a[defaultCol];
          });

          new Vue({
            el: "main",
            data: {
              gridColumns: ["country", "cases", /*"casesPerOneMillion",*/ "recovered", "critical", "deaths", "rate", "deathsPerOneMillion", "todayCases", "todayDeaths"],
              gridData: data.map(function(c){
                c.rate=c.deaths*100/c.cases;
                return c;
              })
            }
          });
        });

      });
    </script>
  </body>
</html>
